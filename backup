terraform {
  required_version = ">= 0.14"
  required_providers {
    proxmox = {
      source = "telmate/proxmox"
		  version = "2.9.11"
    }
  }
}

variable "master_address" {}

variable "worker_address" {}

provider "proxmox" {
  pm_api_url = "https://zeus.onemarc.io:8006/api2/json"
  pm_user    = "root@pam"
  pm_password = "hdesk666!"
  # pm_api_token_id = "root@pam!mptd"
  # pm_api_token_secret = "3b46b621-afe8-4ea2-87ae-1ef8526d4af7"
  pm_tls_insecure = "true"
}

variable "ssh_key" {
  default = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDdhPFPI0HldSQ7kSCtiPq1itebiaAaDE4gJcmdrCVigZLoL5mRpt7x4amwHymyuAINy9/j4DyiTLH8JnAp78AczFrR38EYl4YaOqFdJa4voLeUumed3GmfCULPdiKKdzw6rHzHpO+2poewn342J1uEYowO0TOD87/eh8G28amrkXm+21DiD1WxycmOqpk95KuJL7Mx0yKvS6ffhg0WISzfD9UhSe/+SrLQI4jMnS7vq+lDqpBAK76cctS4XRw3cLiA+LFwi44SnGdurXOZAToNu2pqQQyMCcJ8P3FHi8jV5OB1qrGo/dM2LT6RykncBTd1TQlb2+LhhtNaS6a4YnJFMmdo9TqaPAZj6gM27LfGCwBem3GOud2YFrjzU5dnsIBZ2PL6L7GvAHTGwc1qEBHdjyBseNXTkisnFFu5BFjpQ7R/2dWrNCvAS3103WhAE1MVNYppO50X/YdBT15EUlC7UtvmuZm1iPn8rLtOvL3kNJxzGcfUBEi4/rNCqI99WbVfVM0jYU5pM1HF1SAwzZf3/Jxq8Jipo6NcCySOIWkluEbX/Y63gfI6eKKaZknx54VNXU6/4Fu7E82rXckSIFWbfI6koEeqZehjax4yeQmkDdhc5/2wYH1TQNP6750K7bGIFshWLhdKIeaGWaGF61dgUcVeOMfFP8ZpRmvZGs8SMw== proxmox_template_key"
}

# resource confriguration: master nodes

resource "proxmox_vm_qemu" "k3s_server" {
  count                     = 2
  vmid                      = "40${count.index}"
  name                      = "k3s-m40${count.index}"
  target_node               = "zeus"

  clone                     = "ubuntu-server-24-04"
  full_clone                = true

  os_type                   = "ubuntu"

  sockets                   = 1
  cores                     = 4
  cpu                       = "kvm64"	# if empty 'host' is default

  memory                    = 4096
  balloon                   = 1024

  scsihw                    = "virtio-scsi-pci"
  bootdisk                  = "scsi0"

  # Activate QEMU Agent
  agent                     = 1

  disk {
    size                    = "32G"
    type                    = "scsi"
    # storage                 = "storagesyn"
    storage                 = "local.lvm"
    format                  = "qcow2"
  }

  network {
    model                   = "virtio"
    bridge                  = "vmbr0"
    macaddr                 = var.master_address[count.index]   # Get mac address from variable list master_address
  }

  lifecycle {
    ignore_changes  = [
      network
    ]
  }

  sshkeys = <<EOF
  ${var.ssh_key}
  EOF

}

# resource confriguration: worker nodes

resource "proxmox_vm_qemu" "k3s_workers" {
  count                     = 6
  vmid                      = "50${count.index}"
  name                      = "k3s-w50${count.index}"
  target_node               = "zeus"

  clone                     = "ubuntu-server-24-04"
  full_clone                = true

  os_type                   = "ubuntu"

  sockets                   = 1
  cores                     = 4
  cpu                       = "kvm64"	# if empty 'host' is default

  memory                    = 4096
  balloon                   = 1024

  scsihw                    = "virtio-scsi-pci"
  bootdisk                  = "scsi0"

  # Activate QEMU Agent
  agent                     = 1

  disk {
    size                    = "32G"
    type                    = "scsi"
    # storage                 = "storagesyn"
    storage                 = "local.lvm"
    format                  = "qcow2"
  }

  network {
    model                   = "virtio"
    bridge                  = "vmbr0"
    macaddr                 = var.worker_address[count.index]   # Get mac address from variable list worker_address
  }

  lifecycle {
    ignore_changes  = [
      network
    ]
  }

  sshkeys = <<EOF
  ${var.ssh_key}
  EOF

}